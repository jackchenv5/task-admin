import {defineStore} from 'pinia'
import {ref, computed} from 'vue'
import mpServices from "../services/mpServices";

export const userProjectStore = defineStore('project', () => {
    //project 信息
    //对比项目列表
    const focusProjectNames = ref([])
    const focusProjects = ref([])
    const focusProjectsData = ref({})
    //获取关注项目名列表
    const getFocusProjectNames = () => {
        mpServices.project('get_attention_project_list').then(
            (ret) => {
                focusProjectNames.value = (ret.data.map(x => x.name))
            }
        )
    }
    //获取关注项目列表
    const updateFocusProjects = () => {
        mpServices.project('get_attention_project_list').then(
            (ret) => {
                focusProjects.value = (ret.data.map(x => {
                    getProjectBudgetData(x.id).then( y=>{
                        focusProjectsData.value[x.name] = y
                    })
                    return {
                        "name": x.name,
                        "items": [
                            {name: "属主", value: x.author},
                            {name: "项目ID", value: x.id},
                            {name: "当前状态", value: x.status},
                            {name: "项目代号", value: `${x.name.substring(0, 10)}-${x.name.length}`},
                        ],
                    }
                }))
            }
        )
    }
    //设置关注取消
    const setFocusProject = (projectId, opt) => {
        return mpServices.project('set_attention_project_id', {'project_id': projectId, 'opt': opt}).then(
            (ret) => {
                //状态修改成功，切换状态值
                updateFocusProjects()
                return ret.status === 201 ? true : false
            }
        )
    }
    //是否关注
    const isFocusProject = (projectId) => {
        return mpServices.project('check_is_attention', {'project_id': projectId}).then(
            (ret) => {
                //状态修改成功，切换状态值
                return ret.data.status
            }
        )
    }

    //查询
    const searchProject = (queryString) => {
        return mpServices.project('get_list', {'project_name': queryString}).then(
            (ret) => {
                const filterList = ret.data.filter(x => {
                    return x.name.toLowerCase().indexOf(queryString.toLowerCase()) != -1
                })
                return filterList
            })
    }

    //获取项目详细数据

    const getProjectBudgetData = (projectId) => {
        return mpServices.project('get_budget_summary', {'project_id': projectId}).then(ret => {
            return ret.data
        })
    }

    return {
        focusProjects,
        focusProjectNames,
        focusProjectsData,
        getFocusProjectNames,
        updateFocusProjects,
        setFocusProject,
        isFocusProject,
        searchProject,
    }

})